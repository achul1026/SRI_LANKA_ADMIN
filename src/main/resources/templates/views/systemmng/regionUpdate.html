<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="content">
	<h3 class="info-title" th:text="#{region.regionUpdate.title}">지역 코드 등록</h3>
	<div class="is-box">
		<div class="region-box">
			<h3 class="cm-code-title mb8" th:text="#{region.common.dsd}">- DSD 코드</h3>
<!-- 			<input type="button" class="is-key-button" id="dsdRegistBtn" value="DSD 등록" /> -->
		</div>
		<div>
			<input type="hidden" id="dsdId" th:value="${dsdInfo.dsdId}">
			<table class="list-table">
				<tr>
					<th th:text="#{region.common.dsd}">DSD CODE</th>
					<th th:text="#{region.common.dsd.name}">DSD NAME</th>
					<th th:text="#{region.common.province.code}">Province CODE</th>
					<th th:text="#{region.common.district.code}">District CODE</th>
				</tr>
				<tr>
					<td th:text="${dsdInfo.dsdId}"></td>
					<td th:text="|${dsdInfo.provinNm} > ${dsdInfo.districtNm} > ${dsdInfo.dsdNm}|">TEST</td>
					<td th:text="${dsdInfo.provinCd}">TEST</td>
					<td th:text="${dsdInfo.districtCd}">TEST</td>
				</tr>
			</table>
		</div>
	</div>
	<div class="list-table-container is-box mt16">
		<div class="region-box">
			<h3 class="cm-code-title" th:text="#{region.common.taz}">- TAZ 코드</h3>
			<input type="button" class="is-key-button" id="tazRegistBtn" th:value="#{region.regionSave.registTaz}"/>
		</div>
		<table class="list-table">
			<thead>
				<tr>
					<th th:text="#{region.common.taz}">TAZ CODE</th>
					<th th:text="#{region.common.lat}">중앙 위도</th>
					<th th:text="#{region.common.lon}">중앙 경도</th>
					<th th:text="#{region.common.ratio}">비율(%)</th>
					<th th:text="#{invst.common.table.management}">관리</th>
				</tr>
			</thead>
			<tbody id="regionSelectAddBox">
				<tr class="taz-select-tr" th:data-rc="${item.dstrctCd}" th:data-tc="${item.dstrctId}" th:each="item:${dsdInfo.tazCodeInfoList}">
					<td class="taz-list-code" th:text="${item.dstrctCd}"></td>
					<td class="taz-list-name cntr-lat" th:text="${item.cntrLat}"></td>
					<td class="taz-list-name cntr-lon" th:text="${item.cntrLon}"></td>
					<td>
						<input type="hidden" class="taz-code taz-district-code" th:value="${item.dstrctCd}">
						<input type="text" class="input-table-text region-code-percentage" th:value="${item.distrbCnt}" oninput="inputOnlyNumber(this)" th:placeholder="#{region.common.placeholder.ratio}">
					</td>
					<td><input type="button" class="input-reset pointer" th:value="#{common.button.delete}" onclick="tazListRemove(this)"/></td>
				</tr>
				<tr class="regionListNotData none">
					<td colspan="4" th:text="#{common.search.result.notExist}">검색 결과가 없습니다.</td>
				</tr>
			</tbody>
		</table>
		<div class="info-button-box">
			<a th:href="@{/systemmng/region/{dsdId}(dsdId=${dsdInfo.dsdId})}" class="is-basic-button" th:text="#{common.button.prePage}">이전 페이지</a> 
			<input type="button" class="is-key-button overLapping" th:value="#{common.button.update}" onclick="dsdRegionUpdate()"/>
		</div>
	</div>
</th:block>
</html>
<script>
//TAZ 코드 목록 저장
document.addEventListener("DOMContentLoaded", function () {
	let tazCodes = document.querySelectorAll('.taz-select-tr');
	let cntrLats = document.querySelectorAll('.cntr-lat');
	let cntrLons = document.querySelectorAll('.cntr-lon');
	let tazDistrictCodes = document.querySelectorAll('.taz-code');
	let tazPercentages = document.querySelectorAll('.region-code-percentage');
    let regionContent = [];
	for (let i = 0; i < tazCodes.length; i++) {
	    let tazCode = tazCodes[i].dataset.tc;
	    let cntrLat = cntrLats[i].innerText;
	    let cntrLon = cntrLons[i].innerText;
	    regionContent = [cntrLat,cntrLon];
	    let tazDistrictCode = tazDistrictCodes[i].value;
	    let tazPercentage = tazPercentages[i].value;
	    checkedRegionContentArray.push([tazCode, regionContent, tazPercentage]);
	console.log(checkedRegionContentArray);
	    checkedRegionDisplayCodeArray.push(tazDistrictCode);
	}
});

document.getElementById('tazRegistBtn').addEventListener('click', () => {
	setTazModal('TAZ');
});

function asynchronousSearchList(){
	setTazModal('TAZ');
}

function setTazModal(type){
	let paramData = $("#searchForm").serialize();
	const modalContainer = document.querySelector('.modal-container');
	if(modalContainer) modalContainer.remove();	
		new ModalBuilder().init(message.code.code_taz_save, "1200").ajaxBody(__contextPath__ + "/systemmng/region/save/taz",paramData).footer(3,message.common.button_regist,function(button, modal){
			if(checkedRegionNameArray.length == 0) {
				alert(message.code.code_taz_update);
				return
			}
			tazModalSave();
			modal.close();
		}, message.common.button_cancel, function(button, modal){
			checkedRegionContentArray = tazCodeDefaultArray.map(innerArray => innerArray.slice());
			modal.close();
		}).open();
		regionPagingAdd(type);
}

function dsdRegionUpdate(){
	let dsdId = document.getElementById('dsdId').value;

	let tazArray = document.querySelectorAll('.taz-select-tr');
	let tazInfoArr = new Array();
	
	if(tazArray.length > 0){
		for (let i = 0; i < tazArray.length; i++) {
            let tazTr = tazArray[i];
			let tazInfo = new Object();

			let dstrctCd = tazTr.querySelector('.taz-district-code').value;
			let dstrbCnt = tazTr.querySelector('.region-code-percentage');
            
            if (!dstrbCnt.value) {
                alert(message.authRqst.authSetting_emptyValidation);
                dstrbCnt.focus();
                return;
            }
            
            tazInfo.dstrctCd = dstrctCd;
            tazInfo.dstrbCnt = dstrbCnt.value;

			tazInfoArr.push(tazInfo);		
		}
		
		let data = {
		    dsdId: dsdId,
		    tazInfoArr: tazInfoArr
		};
		
		const loading = new setLoading().start();
	
		fetch(__contextPath__ +"/systemmng/region/"+dsdId, {
			method: "PUT",
		    headers: {
		        'Content-Type': 'application/json'
		    },
		    body: JSON.stringify(data)
		}).then(response => response.json())
		.then(result => {
			if(result.code == 200){
				location.href="/systemmng/region/"+dsdId;
			} else {
				alert(result.message);
			}
		}).catch(error => {
			return;
		}).finally(() => {
			loading.end();
		});
	} else {
		alert(message.openAPI.openApiUpdate_at_least_one_required);
	}
}
</script>